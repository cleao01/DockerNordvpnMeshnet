#!/bin/bash

shopt -s nocasematch
## Client information
nordvpn version | grep -Eiv "new feature"

## Apply settings
[[ -n ${DNS} ]] && nordvpn set dns ${DNS//[;,]/ } | grep -Eiv -f /opt/inv-grep
[[ -n ${CYBER_SEC} ]] && nordvpn set cybersec ${CYBER_SEC} | grep -Eiv -f /opt/inv-grep
[[ -n ${OBFUSCATE} ]] && nordvpn set obfuscate ${OBFUSCATE} | grep -Eiv -f /opt/inv-grep
[[ -n ${PROTOCOL} ]] && nordvpn set protocol ${PROTOCOL} | grep -Eiv -f /opt/inv-grep
nordvpn set technology ${TECHNOLOGY:-NordLynx} | grep -Eiv -f /opt/inv-grep
## NordVPN firewall disabled by default
[[ -z ${FIREWALL} ]] && FIREWALL=false
nordvpn set firewall ${FIREWALL} | grep -Eiv -f /opt/inv-grep
## Firewall must be enabled to enable killswitch
## Be warned that NordVPn firewall = true breaks ALLOW_LIST
if [[ "${FIREWALL}" == "true" ]]
then
  if [[ -n ${KILLSWITCH} ]]
  then
    nordvpn set killswitch ${KILLSWITCH} | grep -Eiv -f /opt/inv-grep
  fi
fi

[[ -n ${PORTS} ]] && for port in ${PORTS//[;,]/ }
do
  nordvpn whitelist add port "${port}" | grep -Eiv -f /opt/inv-grep
done
[[ -n ${PORT_RANGE} ]] && nordvpn whitelist add ports ${PORT_RANGE} | grep -Eiv -f /opt/inv-grep

docker_networks=$(dockerNetworks)
if [[ -n ${docker_networks} ]]
then
  IFS=',' read -ra networks <<< "$docker_networks"
  for net in "${networks[@]}"
  do
    network=($net)
    nordvpn whitelist add subnet "${network[1]}" | grep -Eiv -f /opt/inv-grep
  done
fi
[[ -n ${NETWORK} && -z ${NET_LOCAL} ]] && NET_LOCAL=${NETWORK}
[[ -n ${NET_LOCAL} ]] && for net in ${NET_LOCAL//[;,]/ }
do
  nordvpn whitelist add subnet "${net}" | grep -Eiv -f /opt/inv-grep
done

exit 0
