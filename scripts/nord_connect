#!/bin/bash

[[ -n ${PRE_CONNECT} ]] && eval ${PRE_CONNECT}

current_sleep=1
until nordvpn connect ${CONNECT} | grep -Ei -f /opt/reg-grep | grep -Eiv version
do
  if [ ${current_sleep} -gt 32 ]
  then
    echo -e $(date "+%F %T%z") "\tWARNING\tUnable to connect."
    exit 1
  fi
  echo -e $(date "+%F %T%z") "\tWARNING\tUnable to connect; retrying in ${current_sleep} seconds."
  sleep ${current_sleep}
  current_sleep=$((current_sleep * 2))
done

[[ -n ${POST_CONNECT} ]] && eval ${POST_CONNECT}

exit 0
